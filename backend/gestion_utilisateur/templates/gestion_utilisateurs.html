{% extends 'base.html' %} {% block content %}
<div class="container">
  <h2>Gestion des Utilisateurs</h2>

  {% if messages %} {% for message in messages %}
  <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %} {% endif %}

  <table class="table">
    <thead>
      <tr>
        <th>Nom d'utilisateur</th>
        {% comment %}
        <th>Rôle</th>
        <th>Statut</th>
        {% endcomment %}
        <th>Groupes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for utilisateur in utilisateurs %}
      <tr>
        <td>{{ utilisateur.username }}</td>
        <td>{{ utilisateur.role.name }}</td>
        {% comment %}
        <td>
          {% if utilisateur.valide %} Validé {% else %} En attente {% endif %}
        </td>
        <td>
          {% for groupe in utilisateur.groups.all %} {{ groupe.name }}{% if not
          forloop.last %}, {% endif %} {% endfor %}
        </td>
        {% endcomment %}
        <td>
          {% if perms.auth.change_group %}
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#groupModal-{{ utilisateur.id }}"
          >
            Modifier groupe
          </button>
          {% endif %}
          <!-- Modal -->
          <div
            class="modal fade"
            id="groupModal-{{ utilisateur.id }}"
            tabindex="-1"
            aria-labelledby="groupModalLabel-{{ utilisateur.id }}"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5
                    class="modal-title"
                    id="groupModalLabel-{{ utilisateur.id }}"
                  >
                    Modifier le groupe de {{ utilisateur.username }}
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form
                    id="groupForm-{{ utilisateur.id }}"
                    action="{% url 'gestion_utilisateurs' %}"
                    method="POST"
                  >
                    {% csrf_token %}
                    <input
                      type="hidden"
                      name="utilisateur_id"
                      value="{{ utilisateur.id }}"
                    />
                    <input
                      type="hidden"
                      name="action"
                      value="set_single_group"
                    />
                    <div class="mb-3">
                      <label
                        for="groupeSelect-{{ utilisateur.id }}"
                        class="form-label"
                        >Sélectionner un groupe</label
                      >
                      <select
                        class="form-select"
                        id="groupeSelect-{{ utilisateur.id }}"
                        name="groupe_id"
                        required
                      >
                        <option value="">-- Choisir un groupe --</option>
                        {% for groupe in groupes %}
                        <option
                          value="{{ groupe.id }}"
                          {%
                          if
                          groupe
                          in
                          utilisateur.groups.all
                          %}selected{%
                          endif
                          %}
                        >
                          {{ groupe.name }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="form-text">
                      Note : Un utilisateur ne peut appartenir qu'à un seul
                      groupe. La sélection remplacera tout groupe existant.
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Fermer
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="document.getElementById('groupForm-{{ utilisateur.id }}').submit();"
                  >
                    Enregistrer
                  </button>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- Bootstrap JS (with Popper.js included) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
      document.querySelectorAll('#groupForm-{{ utilisateur.id }}').forEach(form => {
          form.addEventListener('submit', function(e) {
              // Remove all existing groups before setting the new one
              {% for utilisateur in utilisateurs %}
                  fetch('/gestion_utilisateur/clear_groups/', {
                      method: 'POST',
                      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                      body: new URLSearchParams({ utilisateur_id: '{{ utilisateur.id }}' })
                  });
              {% endfor %}
          });
      });
  });
</script>
{% endblock %}
