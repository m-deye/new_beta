{% extends 'base.html' %} {% block content %}
<div class="container">
  <h2>Modifier les Permissions du Groupe : {{ groupe.name }}</h2>

  <div class="row">
    <!-- Permissions disponibles -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Permissions Disponibles</h5>
        </div>
        <div class="card-body">
          <ul class="list-group" id="permissions-disponibles-{{ groupe.id }}">
            {% for perm in permissions_disponibles %}
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
            >
              {{ perm.name }}
              <button
                type="button"
                class="btn btn-sm btn-primary ajouter-permission"
                data-groupe-id="{{ groupe.id }}"
                data-permission-id="{{ perm.id }}"
              >
                <i class="fas fa-arrow-right"></i>
              </button>
            </li>
            {% empty %}
            <p>Aucune permission disponible.</p>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Permissions attribuées -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Permissions Attribuées</h5>
        </div>
        <div class="card-body">
          <ul class="list-group" id="permissions-groupe-{{ groupe.id }}">
            {% for perm in permissions_attribuees %}
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
            >
              {{ perm.name }}
              <button
                type="button"
                class="btn btn-sm btn-danger retirer-permission"
                data-groupe-id="{{ groupe.id }}"
                data-permission-id="{{ perm.id }}"
              >
                <i class="fas fa-times"></i>
              </button>
            </li>
            {% empty %}
            <p>Aucune permission attribuée.</p>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <a href="{% url 'gestion_permissions_groupes' %}" class="btn btn-secondary"
      >Retour</a
    >
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Ajouter une permission au groupe
    document.querySelectorAll(".ajouter-permission").forEach((button) => {
      button.addEventListener("click", function () {
        const groupeId = this.dataset.groupeId;
        const permissionId = this.dataset.permissionId;
        const item = this.parentElement;

        fetch("/gestion_utilisateur/ajouter-permission-groupe/", {
          method: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          body: new URLSearchParams({
            groupe_id: groupeId,
            permission_id: permissionId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              document
                .getElementById(`permissions-groupe-${groupeId}`)
                .appendChild(item);
              this.classList.remove("btn-primary", "ajouter-permission");
              this.classList.add("btn-danger", "retirer-permission");
              this.innerHTML = '<i class="fas fa-times"></i>';

              // Supprimer l'ancien événement et ajouter le nouveau pour retirer la permission
              this.removeEventListener("click", arguments.callee);
              this.addEventListener("click", retirerPermissionHandler);
            }
          });
      });
    });

    // Fonction pour retirer une permission
    function retirerPermissionHandler() {
      const groupeId = this.dataset.groupeId;
      const permissionId = this.dataset.permissionId;
      const item = this.parentElement;

      fetch("/gestion_utilisateur/retirer-permission-groupe/", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: new URLSearchParams({
          groupe_id: groupeId,
          permission_id: permissionId,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            document
              .getElementById(`permissions-disponibles-${groupeId}`)
              .appendChild(item);
            this.classList.remove("btn-danger", "retirer-permission");
            this.classList.add("btn-primary", "ajouter-permission");
            this.innerHTML = '<i class="fas fa-arrow-right"></i>';

            // Supprimer l'ancien événement et ajouter le nouveau pour ajouter la permission
            this.removeEventListener("click", retirerPermissionHandler);
            this.addEventListener("click", function () {
              ajouterPermissionHandler.call(this);
            });
          }
        });
    }

    // Attacher l'événement aux boutons existants pour retirer une permission
    document.querySelectorAll(".retirer-permission").forEach((button) => {
      button.addEventListener("click", retirerPermissionHandler);
    });
  });
</script>

{% endblock %}
