{% extends "base.html" %}
{% block content %}

<!-- Modale pour afficher les détails de l'offre -->
<!-- Modale pour afficher les détails de l'offre -->
<div class="modal fade" id="offreModal" tabindex="-1" role="dialog" aria-labelledby="offreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="offreModalLabel">Détails de l'offre</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <p><strong>Description :</strong></p>
                    <div id="modal-description" class="wysiwyg-content border p-2" style="max-height: 300px; overflow-y: auto;"></div>
                    
                    <p><strong>Date limite :</strong> <span id="modal-date-limite" class="badge badge-primary"></span></p>
                    <p><strong>Lieu :</strong> <span id="modal-lieu"></span></p>
                    <p><strong>Statut :</strong> <span id="modal-statut" class="badge"></span></p>

                    <h2>Documents associés</h2>
                    <ul id="modal-documents" class="list-group">
                        <!-- Les documents seront injectés ici dynamiquement -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Begin Page Content -->
<div class="container-fluid"><div class="d-flex justify-content-between align-items-center mb-3">
    <center><h1>Liste des offres d'emploi</h1></center>
    
    {% comment %} <a href="{% url 'creer_offre' %}">
        <button type="button" class="btn btn-primary">Créer une offre</button>
    </a> {% endcomment %}
</div>
       


    <div class="container-fluid">
        <p class="mb-4"></p>

        <!-- DataTales Example -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="table-responsive">
                    <!-- Tableau des offres -->
                    <table class="table table-hover table-striped" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Titre</th>
                                <th>Nombre de vues</th>
                                <th>État</th>
                                <th>Client</th>
                                <th>Date limite</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for offre in offres %}
                            {% comment %} class="{% if offre.si_valider %}table-success{% else %}table-danger{% endif %}" {% endcomment %}
                            <tr >

                                <td>
                                    {{ offre.titre|safe }}<br>
                                    {% comment %} {% if offre.offre_principale %}
                                        {{ offre.titre|safe }}<br>
                                        {{ offre.offre_principale.titre|striptags }}
                                    {% else %}
                                        {{ offre.titre|safe }}
                                    {% endif %} {% endcomment %}
                                </td>
                                
                                <td>{{ offre.nombre_vu }}</td>
                                <td>
                                    {% if offre.si_valider %}
                                        Validé
                                    {% else %}
                                        Non Validé
                                    {% endif %}
                                </td>
                                <td>{{ offre.client.utilisateur.username }}</td>
                                <td>{{ offre.date_limite|date:"d/m/Y" }}</td>



                                <td>
                                    <form method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="offre_id" value="{{ offre.id }}">
                                        
                                        <!-- Bouton Publier/Dépublier -->
                                        {% comment %} {% if offre.si_publier %}
                                            <button class="btn btn-danger btn-icon-split" type="submit" name="action" value="depublier" title="Dépublier l'offre" style="margin: 3px;">
                                                <i class="fa-regular fa-globe-pointer"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-success btn-icon-split" type="submit" name="action" value="publier" {% if not offre.si_valider %}disabled{% endif %} title="Publier l'offre" style="margin: 3px;">
                                                <i class="fa-regular fa-globe-pointer"></i>
                                            </button>
                                        {% endif %} {% endcomment %}
                                            
                                        <!-- Boutons Supprimer, Modifier et Détails -->
                                        {% if perms.offres_emploi.delete_offreemploi %}
                                            <button class="btn btn-danger btn-icon-split" type="submit" name="action" value="supprimer" {% if offre.si_valider %}disabled{% endif %} title="Supprimer l'offre" style="margin: 3px;">
                                                <i class="fa-sharp fa-solid fa-trash"></i>
                                            </button>
                                        {% endif %}

                                        {% if perms.offres_emploi.change_offreemploi %}
                                            <button class="btn btn-success btn-icon-split" type="submit" name="action" value="modifier" {% if offre.si_valider %}disabled{% endif %} title="Modifier l'offre" style="margin: 3px;">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </button>
                                        {% endif %}
                                        
                                        <!-- Bouton Valider/Invalider -->
                                        {% if perms.offres_emploi.valider_offreemploi %}
                                        {% if offre.si_valider %}
                                            <button class="btn btn-danger btn-icon-split" type="submit" name="action" value="invalider" title="Dévalider l'offre" style="margin: 3px;">
                                                <i class="fa-solid fa-badge-check"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-success btn-icon-split" type="submit" name="action" value="valider" title="Valider l'offre" style="margin: 3px;">
                                                <i class="fa-solid fa-badge-check"></i>
                                            </button>
                                        {% endif %}
                                        {% endif %}
                                        {% comment %} {% if perms.offres_emploi.change_offreemploi %} {% endcomment %}
                                        <a href="{% url 'traduire_offre' offre.id %}" class="btn btn-warning btn-icon-split" title="Traduire l'offre" style="margin: 3px;">
                                            <i class="fa-solid fa-language"></i>
                                        </a>
                                        {% comment %} {% endif %}  {% endcomment %}
                                        <!-- Bouton pour ouvrir la modale des détails -->
                                        <button type="button" class="btn btn-info btn-icon-split" data-toggle="modal" data-target="#offreModal" data-offre-id="{{ offre.id }}" title="Voir les détails de l'offre" style="margin: 3px;">
                                            <i class="fa-sharp fa-solid fa-eye"></i>
                                        </button>
                                    </form>
                                    {% if perms.offres_emploi.fixe_offreemploi %}
                                        <form method="post" action="{% url 'fixer_offre' offre.id %}" style="display:inline;">
                                            {% csrf_token %}
                                                <button type="submit" class="btn btn-warning btn-icon-split" title="Fixer l'offre">
                                                    <i class="fa-solid fa-thumbtack"></i>
                                                </button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale de confirmation de suppression -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmation de suppression</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer cette offre ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- /.container-fluid -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Bootstrap JS -->
{% comment %} <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> {% endcomment %}
{% comment %} 
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> {% endcomment %}


<!-- Script pour gérer l'affichage des détails de l'offre dans la modale avec éditeur WYSIWYG -->
<script>
    


    

    $(document).ready(function() {
        // Initialisation de DataTables
        $('#dataTable').DataTable({
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Tous"]],
            //"pageLength": 5
            "pageLength": 10, 
            "order": [[5, "desc"]],
            "paging": true, // Activer la pagination
            "searching": true, // Activer la recherche
            //"ordering": true, // Activer le tri
            "info": true, // Afficher les informations de pagination
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.10.21/i18n/French.json" // Traduction en français
            },
            "columnDefs": [
                  // Date limite
                { "width": "115px", "targets": 5 }   // Action
            ],
            "autoWidth": false,
            "fixedColumns": true
            //"columnDefs": [
            //    {
            //        "targets": 5, // Cible la 6ème colonne (index 5)
            //        "width": "180px", // Largeur fixe de 180px
             //       "className": "dt-nowrap" // Empêche le texte de passer à la ligne
             //   },
             //   {
            //        "targets": 1, // Cible la 2ème colonne (index 1)
             //       "width": "50px", // Largeur fixe de 50px
             //       "className": "dt-nowrap" // Empêche le texte de passer à la ligne
             //   }
            //]
        });
    });
    $(document).ready(function() {
        $('#offreModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var offreId = button.data('offre-id');

            $.ajax({
                url: '/detail-offre/' + offreId + '/',
                method: 'GET',
                success: function(data) {
                    $('#offreModalLabel').text(data.titre);
                    $('#modal-description').html(data.description);

                    let dateLimite = new Date(data.date_limite);
                    let options = { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: 'long', 
                        year: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit'
                    };

                    $('#modal-date-limite').text(dateLimite.toLocaleDateString('fr-FR', options));
                    $('#modal-lieu').text(data.lieu);
                    
                    var statutSpan = $('#modal-statut');
                    if (data.si_valider) {
                        statutSpan.text('Publiée').addClass('badge-success').removeClass('badge-danger');
                    } else {
                        statutSpan.text('Non Publiée').addClass('badge-danger').removeClass('badge-success');
                    }

                    var documentsHtml = '';
                    if (data.documents && data.documents.length > 0) {
                        data.documents.forEach(function(doc) {
                            documentsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="${doc.piece_join}" target="_blank">
                                    <i class="fa fa-file-alt"></i> ${doc.titre_document}
                                </a>
                            </li>`;
                        });
                    } else {
                        documentsHtml = '<li class="list-group-item">Aucun document associé.</li>';
                    }
                    $('#modal-documents').html(documentsHtml);
                }
            });
        });
    });

   



    document.addEventListener('DOMContentLoaded', function () {
        const deleteButtons = document.querySelectorAll('button[name="action"][value="supprimer"]');
    
        deleteButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault(); // Empêche l'envoi automatique
    
                Swal.fire({
                    title: "Êtes-vous sûr ?",
                    text: "Cette action est irréversible !",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Oui, supprimer !",
                    cancelButtonText: "Annuler",
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = button.closest('form');
                        if (form) {
                            let hiddenInput = form.querySelector('input[name="action"]');
                            if (!hiddenInput) {
                                hiddenInput = document.createElement("input");
                                hiddenInput.type = "hidden";
                                hiddenInput.name = "action";
                                form.appendChild(hiddenInput);
                            }
                            hiddenInput.value = "supprimer";
                            form.submit(); // Soumet le formulaire avec l'action correcte
                        }
                    }
                });
            });
        });
    });
    
    document.addEventListener('DOMContentLoaded', function () {
        {% for message in messages %}
            Swal.fire({
                toast: true,
                position: "top",  // 🔥 Affiche la notification en haut centré
                icon: "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% elif message.tags == 'info' %}info{% endif %}",
                title: "{{ message }}",
                showConfirmButton: false, // Pas de bouton OK
                timer: 5000, // Disparaît après 5 secondes
                timerProgressBar: true, // Affiche une barre de progression
                background: "#fff",
                color: "#333"
            });
        {% endfor %}
    });
    
   

</script>

{% endblock %}