{% extends "base.html" %} {% load widget_tweaks %} {% block content %}
<body>
  <!-- Modern Toggle Switch Styles -->
  <style>
      .toggle-switch-container {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 20px;
      }
      
      .toggle-switch-label {
          font-weight: 600;
          color: #374151;
          font-size: 14px;
      }
      
      .toggle-switch {
          position: relative;
          display: inline-block;
          width: 56px;
          height: 28px;
      }
      
      .toggle-switch-input {
          opacity: 0;
          width: 0;
          height: 0;
      }
      
      .toggle-slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          border-radius: 28px;
          box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      .toggle-slider:before {
          position: absolute;
          content: "";
          height: 22px;
          width: 22px;
          left: 3px;
          bottom: 3px;
          background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          border-radius: 50%;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      .toggle-switch-input:checked + .toggle-slider {
          background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
          box-shadow: inset 0 2px 4px rgba(59, 130, 246, 0.3), 0 0 0 2px rgba(59, 130, 246, 0.1);
      }
      
      .toggle-switch-input:checked + .toggle-slider:before {
          transform: translateX(28px);
          background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      .toggle-switch:hover .toggle-slider {
          transform: scale(1.02);
      }
      
      .toggle-switch:active .toggle-slider {
          transform: scale(0.98);
      }
      
      .toggle-status-text {
          font-size: 12px;
          color: #6b7280;
          font-weight: 500;
          margin-top: 4px;
      }
      
      .toggle-enabled {
          color: #059669 !important;
      }
      
      .toggle-disabled {
          color: #dc2626 !important;
      }
  </style>
  <div class="container mt-5">
    <h1>Créer une offre</h1>
    {{ offre_form.media }}
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Onglets -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="info-tab"
            data-bs-toggle="tab"
            data-bs-target="#info"
            type="button"
            role="tab"
            aria-controls="info"
            aria-selected="true"
          >
            Informations
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="documents-tab"
            data-bs-toggle="tab"
            data-bs-target="#documents"
            type="button"
            role="tab"
            aria-controls="documents"
            aria-selected="false"
          >
            Documents
          </button>
        </li>
      </ul>

      <!-- Contenu des onglets -->
      <div class="tab-content" id="myTabContent">
        <!-- Onglet Informations -->
        <div
          class="tab-pane fade show active"
          id="info"
          role="tabpanel"
          aria-labelledby="info-tab"
        >
          <h2 class="mt-3">Informations de l'offrrre</h2>
          {% for field in offre_form %}
            {% if field.name == 'afficher_heures' %}
            <!-- Modern Toggle Switch for Afficher Heures -->
            <div class="toggle-switch-container">
                <label class="toggle-switch-label">{{ field.label }}</label>
                <div class="d-flex align-items-center gap-3">
                    <label class="toggle-switch">
                        <input type="checkbox" name="{{ field.name }}" id="{{ field.id_for_label }}" class="toggle-switch-input" {% if field.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-status-text" id="toggle-status">
                        {% if field.value %}
                            <span class="toggle-enabled">✓ Afficher l'heure avec la date</span>
                        {% else %}
                            <span class="toggle-disabled">○ Afficher seulement la date</span>
                        {% endif %}
                    </span>
                </div>
            </div>
            {% else %}
            <div class="form-group mb-3">
              <label for="{{ field.id_for_label }}">
                {{ field.label }} {% if field.field.required %}
                <span class="text-danger">*</span>
                {% endif %}
              </label>
              {{ field|add_class:"form-control" }} {% if field.help_text %}
              <small class="form-text text-muted">{{ field.help_text }}</small>
              {% endif %} {% if field.errors %}
              <div class="text-danger">{{ field.errors }}</div>
              {% endif %}
            </div>
            {% endif %}
          {% endfor %}
        </div>

        <!-- Onglet Documents -->
        <div
          class="tab-pane fade"
          id="documents"
          role="tabpanel"
          aria-labelledby="documents-tab"
        >
          <h2 class="mt-3">Documents</h2>
          {{ document_formset.management_form }}
          <div id="document-forms">
            {% for form in document_formset %}
            <div class="document-form mb-3 border p-3">
              {% for field in form %}
              <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label"
                  >{{ field.label }}</label
                >
                {{ field }} {% if field.help_text %}
                <small class="form-text text-muted"
                  >{{ field.help_text }}</small
                >
                {% endif %} {% if field.errors %}
                <div class="alert alert-danger mt-2">{{ field.errors }}</div>
                {% endif %}
              </div>
              {% endfor %}
              <!-- Ne pas afficher le bouton "Retirer ce document" pour le formulaire initial -->
              {% if not forloop.first %}
              <button type="button" class="btn btn-danger remove-document">
                Retirer ce document
              </button>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          <button type="button" id="add-document" class="btn btn-secondary">
            Ajouter un document
          </button>
        </div>
      </div>

      <!-- Bouton de soumission -->
      <button type="submit" class="btn btn-primary mt-3">Créer l'offre</button>
    </form>
  </div>

  <!-- Bootstrap JS et dépendances -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

  <!-- Toggle Switch Functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleInput = document.getElementById('afficher_heures_toggle');
        const statusText = document.getElementById('toggle-status');
        
        if (toggleInput && statusText) {
            toggleInput.addEventListener('change', function() {
                if (this.checked) {
                    statusText.innerHTML = '<span class="toggle-enabled">✓ Afficher l\'heure avec la date</span>';
                } else {
                    statusText.innerHTML = '<span class="toggle-disabled">○ Afficher seulement la date</span>';
                }
            });
        }
    });

  <!-- Script pour ajouter et retirer des formulaires de documents dynamiquement -->
  <script>
    document
      .getElementById("add-document")
      .addEventListener("click", function () {
        const formCount = document.querySelectorAll(".document-form").length;
        const formContainer = document.createElement("div");
        formContainer.classList.add("document-form", "mb-3", "border", "p-3");

        // Récupérer le formulaire vide et remplacer __prefix__
        let newForm = `{{ document_formset.empty_form.as_p|escapejs }}`
          .replace(/__prefix__/g, formCount)
          .replace(/<p>/g, '<div class="mb-3">') // Remplacer <p> par <div class="mb-3">
          .replace(/<\/p>/g, "</div>") // Fermer les balises <div>
          .replace(/<label/g, '<label class="form-label"') // Ajouter la classe form-label aux labels
          .replace(/<input/g, '<input class="form-control"') // Ajouter la classe form-control aux inputs
          .replace(/<textarea/g, '<textarea class="form-control"') // Ajouter la classe form-control aux textareas
          .replace(/<select/g, '<select class="form-control"'); // Ajouter la classe form-control aux selects

        formContainer.innerHTML = newForm;

        // Ajouter le bouton "Retirer ce document" pour les formulaires ajoutés dynamiquement
        const removeButton = document.createElement("button");
        removeButton.type = "button";
        removeButton.classList.add("btn", "btn-danger", "remove-document");
        removeButton.textContent = "Retirer ce document";
        formContainer.appendChild(removeButton);

        document.getElementById("document-forms").appendChild(formContainer);

        // Mettre à jour le management form
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        totalForms.value = formCount + 1;
      });

    // Gestionnaire d'événements pour retirer un document
    // Gestionnaire d'événements pour retirer un document
    document.addEventListener("click", function (event) {
      if (event.target && event.target.classList.contains("remove-document")) {
        const formToRemove = event.target.closest(".document-form");

        // Vider et désactiver les champs du formulaire avant de le retirer
        const inputs = formToRemove.querySelectorAll("input, textarea, select");
        inputs.forEach((input) => {
          if (input.type !== "hidden") {
            input.value = ""; // Vider la valeur
            input.disabled = true; // Désactiver le champ
          }
        });

        // Ajouter une classe CSS ou une indication pour marquer ce formulaire comme supprimé
        formToRemove.classList.add("d-none");

        // Retirer physiquement le formulaire après un délai (optionnel)
        setTimeout(() => {
          formToRemove.remove();
        }, 300);

        // Mettre à jour le management form pour ajuster le nombre total de formulaires
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        totalForms.value = document.querySelectorAll(
          ".document-form:not(.d-none)"
        ).length;
      }
    });
  </script>
  {% endblock %}
</body>
